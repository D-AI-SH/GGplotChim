# GGplotChim 开发规划

## 项目概述

**项目名称**: GGplotChim  
**项目定位**: 可视化编程工具 - 将 R 语言的 ggplot2 包封装成类似 Scratch 的积木式拖拽界面  
**核心价值**: 降低数据可视化门槛，让非编程人员也能轻松使用 ggplot2 创建专业图表

## 项目目标

- 🎯 提供直观的拖拽式编程界面
- 🎯 实时生成对应的 R 代码
- 🎯 内置 R 语言运行环境
- 🎯 支持常用的 ggplot2 图表类型
- 🎯 提供代码导出和分享功能

---

## 技术架构

### 前端技术栈
- **React 18** - UI 框架
- **React DnD / React Flow** - 拖拽和流程图功能
- **Monaco Editor** - 代码编辑器（实时显示生成的 R 代码）
- **Ant Design / Material-UI** - UI 组件库
- **Zustand / Redux** - 状态管理
- **Tailwind CSS** - 样式框架

### 后端技术栈
- **Node.js + Express** - API 服务器
- **WebR** - 浏览器端运行 R 代码（推荐）
  - 或 **OpenCPU** - R 语言 HTTP API
  - 或 **Rserve** - R 语言服务器
- **WebSocket** - 实时通信

### 数据处理
- **Apache Arrow / Parquet** - 高效数据传输
- **CSV / JSON / Excel** - 数据导入支持

---

## 开发阶段规划

## 第一阶段：基础架构搭建（2-3周）

### 1.1 项目初始化
- [x] 创建 React 项目结构
- [ ] 配置 TypeScript（可选但推荐）
- [ ] 配置 ESLint 和 Prettier
- [ ] 配置路由系统
- [ ] 搭建基础 UI 布局框架

### 1.2 核心模块设计
```
src/
├── components/          # 通用组件
│   ├── BlockPalette/   # 积木面板
│   ├── Canvas/         # 画布区域
│   ├── CodePreview/    # 代码预览
│   └── PlotPreview/    # 图表预览
├── blocks/             # 积木定义
│   ├── data/          # 数据相关积木
│   ├── geom/          # 几何对象积木
│   ├── aes/           # 美学映射积木
│   └── theme/         # 主题相关积木
├── core/              # 核心逻辑
│   ├── blockEngine/   # 积木引擎
│   ├── codeGenerator/ # 代码生成器
│   └── rRunner/       # R 代码执行器
├── store/             # 状态管理
├── utils/             # 工具函数
└── types/             # TypeScript 类型定义
```

### 1.3 R 环境集成调研
- [ ] 评估 WebR 可行性（浏览器端运行 R）
- [ ] 评估 OpenCPU 方案（需要服务器）
- [ ] 评估 Rserve 方案（需要服务器）
- [ ] 选定最终方案并进行 POC 验证

---

## 第二阶段：积木系统开发（3-4周）

### 2.1 积木拖拽系统
- [ ] 实现积木面板组件
- [ ] 实现拖拽功能（React DnD）
- [ ] 实现画布区域
- [ ] 实现积木连接逻辑
- [ ] 实现积木参数配置面板

### 2.2 积木类型定义

#### 数据积木
```javascript
- 📊 数据导入
  - CSV 文件
  - Excel 文件
  - JSON 数据
  - 示例数据集（iris, mtcars, diamonds 等）
- 🔧 数据处理
  - 筛选 (filter)
  - 选择列 (select)
  - 排序 (arrange)
  - 分组 (group_by)
  - 汇总 (summarize)
```

#### ggplot2 核心积木
```javascript
- 🎨 初始化
  - ggplot() - 创建画布
  - aes() - 美学映射

- 📈 几何对象 (geom_*)
  - geom_point() - 散点图
  - geom_line() - 折线图
  - geom_bar() - 柱状图
  - geom_histogram() - 直方图
  - geom_boxplot() - 箱线图
  - geom_violin() - 小提琴图
  - geom_density() - 密度图
  - geom_smooth() - 平滑曲线
  - geom_text() - 文本标签

- 🎯 统计变换 (stat_*)
  - stat_smooth()
  - stat_summary()
  - stat_bin()

- 📐 坐标系统 (coord_*)
  - coord_cartesian()
  - coord_flip()
  - coord_polar()

- 🎭 标度 (scale_*)
  - scale_color_*
  - scale_fill_*
  - scale_x_*
  - scale_y_*

- 🏷️ 标签
  - labs() - 标题和坐标轴标签
  - ggtitle()
  - xlab() / ylab()

- 🎨 主题 (theme_*)
  - theme_minimal()
  - theme_classic()
  - theme_bw()
  - theme() - 自定义主题

- 📊 分面 (facet_*)
  - facet_wrap()
  - facet_grid()
```

### 2.3 积木属性系统
- [ ] 设计积木属性编辑器
- [ ] 实现下拉选择器（选择列名）
- [ ] 实现颜色选择器
- [ ] 实现数值输入器
- [ ] 实现文本输入器
- [ ] 实现条件表达式编辑器

---

## 第三阶段：代码生成引擎（2周）

### 3.1 代码生成器
- [ ] 设计积木到代码的映射规则
- [ ] 实现基础代码生成逻辑
- [ ] 实现管道操作符 %>% 的生成
- [ ] 实现 + 操作符的生成（ggplot2 语法）
- [ ] 代码格式化和美化

### 3.2 代码编辑器集成
- [ ] 集成 Monaco Editor
- [ ] 实现代码高亮（R 语言）
- [ ] 实现实时代码同步
- [ ] 支持手动编辑代码（可选）
- [ ] 代码导出功能（.R 文件）

### 3.3 示例代码生成结果
```r
# GGplotChim 生成的代码
library(ggplot2)
library(dplyr)

# 数据准备
data <- read.csv("data.csv")

# 绘图
plot <- data %>%
  filter(category == "A") %>%
  ggplot(aes(x = value_x, y = value_y, color = group)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE) +
  scale_color_brewer(palette = "Set1") +
  labs(
    title = "散点图示例",
    x = "X轴标签",
    y = "Y轴标签"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    legend.position = "bottom"
  )

# 显示图表
print(plot)

# 保存图表
ggsave("plot.png", plot, width = 10, height = 6, dpi = 300)
```

---

## 第四阶段：R 运行环境（2-3周）

### 4.1 方案一：WebR（推荐）
- [ ] 集成 WebR 库
- [ ] 配置 WASM 加载
- [ ] 实现浏览器端 R 代码执行
- [ ] 处理数据传输（JavaScript ↔ R）
- [ ] 错误处理和日志

**优点**: 
- 无需服务器
- 响应速度快
- 部署简单
- 用户数据隐私性好

**缺点**:
- 首次加载较慢（WASM 文件较大）
- 功能可能有限制

### 4.2 方案二：OpenCPU（备选）
- [ ] 搭建 OpenCPU 服务器
- [ ] 实现前端 API 调用
- [ ] 处理文件上传
- [ ] 图表返回和显示
- [ ] 会话管理

**优点**:
- 功能完整
- 性能好
- 支持所有 R 包

**缺点**:
- 需要服务器
- 部署复杂
- 可能有并发限制

### 4.3 图表渲染
- [ ] 接收 R 生成的图表（PNG/SVG）
- [ ] 在预览区域显示
- [ ] 实现图表缩放和查看
- [ ] 图表导出功能（多种格式）

---

## 第五阶段：用户界面优化（2周）

### 5.1 布局设计
```
+------------------+-------------------+-------------------+
|                  |                   |                   |
|   积木面板        |    画布区域        |    预览区域        |
|   (Block         |    (Canvas)       |    (Preview)      |
|    Palette)      |                   |                   |
|                  |                   |   +------------+  |
|  📊 数据         |                   |   | 代码预览   |  |
|  📈 几何对象     |    拖拽积木       |   |            |  |
|  🎨 美学映射     |    组合逻辑       |   +------------+  |
|  🎭 主题         |                   |   +------------+  |
|  📐 坐标系       |                   |   | 图表预览   |  |
|                  |                   |   |            |  |
+------------------+-------------------+   +------------+  |
|            底部工具栏                 |                   |
+---------------------------------------+-------------------+
```

### 5.2 交互优化
- [ ] 积木拖拽动画
- [ ] 连接线效果
- [ ] 积木高亮和提示
- [ ] 错误提示（红色标记）
- [ ] 撤销/重做功能
- [ ] 快捷键支持

### 5.3 响应式设计
- [ ] 支持不同屏幕尺寸
- [ ] 移动端适配（可选）
- [ ] 面板可折叠/展开

---

## 第六阶段：数据管理（1-2周）

### 6.1 数据导入
- [ ] CSV 文件上传
- [ ] Excel 文件上传
- [ ] JSON 数据粘贴
- [ ] 内置示例数据集
- [ ] URL 数据导入

### 6.2 数据预览
- [ ] 数据表格显示
- [ ] 列信息展示（类型、范围）
- [ ] 数据统计摘要
- [ ] 缺失值检测

### 6.3 数据处理积木
- [ ] 筛选行
- [ ] 选择列
- [ ] 数据转换
- [ ] 分组聚合
- [ ] 数据排序

---

## 第七阶段：高级功能（2-3周）

### 7.1 项目管理
- [ ] 保存项目（本地存储）
- [ ] 加载项目
- [ ] 导出项目（JSON）
- [ ] 导入项目
- [ ] 云端保存（可选）

### 7.2 模板系统
- [ ] 内置图表模板
  - 散点图模板
  - 柱状图模板
  - 折线图模板
  - 箱线图模板
  - 热力图模板
- [ ] 自定义模板保存
- [ ] 模板分享

### 7.3 代码库
- [ ] 代码片段库
- [ ] 常用配置快捷应用
- [ ] 配色方案库
- [ ] 主题库

### 7.4 协作功能（可选）
- [ ] 项目分享链接
- [ ] 在线协作编辑
- [ ] 评论和反馈
- [ ] 版本历史

---

## 第八阶段：测试和优化（2周）

### 8.1 功能测试
- [ ] 单元测试（Jest）
- [ ] 组件测试（React Testing Library）
- [ ] E2E 测试（Playwright / Cypress）
- [ ] R 代码执行测试

### 8.2 性能优化
- [ ] 代码分割和懒加载
- [ ] 虚拟滚动（大型积木列表）
- [ ] 图表渲染优化
- [ ] 内存管理

### 8.3 用户体验测试
- [ ] 用户调研
- [ ] A/B 测试
- [ ] 可用性测试
- [ ] 问题收集和修复

---

## 第九阶段：文档和部署（1-2周）

### 9.1 用户文档
- [ ] 快速入门教程
- [ ] 积木使用指南
- [ ] 示例项目
- [ ] FAQ
- [ ] 视频教程

### 9.2 开发者文档
- [ ] API 文档
- [ ] 架构说明
- [ ] 贡献指南
- [ ] 积木开发指南

### 9.3 部署
- [ ] 生产环境配置
- [ ] CI/CD 流程
- [ ] Docker 容器化（如需要）
- [ ] 域名和 HTTPS 配置
- [ ] 性能监控

---

## 技术难点和解决方案

### 难点 1: R 语言运行环境
**问题**: 如何在浏览器中运行 R 代码？

**解决方案**:
1. **WebR（推荐）**: 使用 WebAssembly 在浏览器中运行 R
2. **OpenCPU**: 搭建服务器端 R 环境
3. **混合方案**: 简单操作用 WebR，复杂操作用服务器

### 难点 2: 复杂的 ggplot2 语法
**问题**: ggplot2 语法灵活，如何用积木表达？

**解决方案**:
- 分层设计：数据层 → 美学层 → 几何层 → 主题层
- 使用管道式连接，模拟 `+` 操作符
- 提供"高级选项"面板用于复杂配置

### 难点 3: 代码和积木的双向同步
**问题**: 如何保持代码和积木的一致性？

**解决方案**:
- 以积木为主，代码为辅（单向生成）
- 或者实现代码解析器（反向解析，较复杂）
- 提供"导入代码"功能（第二阶段实现）

### 难点 4: 大数据处理
**问题**: 浏览器处理大型数据集可能性能不足

**解决方案**:
- 数据采样预览
- 后端处理大数据
- 使用 Web Worker 处理数据
- 使用 Apache Arrow 优化数据传输

---

## 里程碑时间表

| 阶段 | 内容 | 预计时间 | 关键产出 |
|------|------|---------|---------|
| M1 | 基础架构 | 2-3周 | 项目骨架、UI布局 |
| M2 | 积木系统 | 3-4周 | 可拖拽的积木面板 |
| M3 | 代码生成 | 2周 | 实时生成 R 代码 |
| M4 | R 环境 | 2-3周 | 可执行代码并显示图表 |
| M5 | UI 优化 | 2周 | 完整的用户界面 |
| M6 | 数据管理 | 1-2周 | 数据导入和处理 |
| M7 | 高级功能 | 2-3周 | 模板、保存、分享 |
| M8 | 测试优化 | 2周 | 稳定版本 |
| M9 | 部署上线 | 1-2周 | 生产环境发布 |

**总计**: 约 17-23 周（4-6 个月）

---

## 核心功能优先级

### P0（必须有）- MVP
- ✅ 基础拖拽系统
- ✅ 常用图表类型（散点图、柱状图、折线图）
- ✅ 代码生成
- ✅ R 代码执行
- ✅ 图表预览
- ✅ 数据导入（CSV）

### P1（重要）
- 📊 更多图表类型（箱线图、直方图、密度图）
- 📊 主题系统
- 📊 项目保存/加载
- 📊 代码导出
- 📊 示例数据集

### P2（可选）
- 🎨 模板系统
- 🎨 协作功能
- 🎨 云端存储
- 🎨 代码解析（反向工程）
- 🎨 高级数据处理

---

## 技术选型建议

### 拖拽库选择
1. **React DnD** - 功能强大，灵活性高
2. **React Flow** - 适合流程图和节点编辑
3. **dnd-kit** - 现代化，性能好

**推荐**: React Flow（适合块状拖拽和连接）

### R 运行环境选择
1. **WebR** - 浏览器端，适合 MVP
2. **OpenCPU** - 服务器端，适合生产环境

**推荐**: 先用 WebR 快速原型，后期可以加入 OpenCPU 支持

### 状态管理
- **Zustand** - 简单，适合中小型项目
- **Redux Toolkit** - 功能完整，适合大型项目

**推荐**: Zustand（减少学习成本）

---

## 潜在风险和应对

### 风险 1: WebR 加载时间长
**应对**: 
- 添加加载进度条
- 使用 CDN 加速
- 考虑混合方案

### 风险 2: ggplot2 功能覆盖不全
**应对**:
- 分阶段实现
- 提供"自定义代码块"功能
- 持续收集用户需求

### 风险 3: 性能问题
**应对**:
- 虚拟化长列表
- 节流/防抖
- Web Worker 处理数据

---

## 参考资源

### 类似项目
- **Scratch** - 可视化编程启发
- **Blockly** - Google 的积木式编程框架
- **Observable** - 数据可视化笔记本
- **Rawgraphs** - 在线可视化工具

### R 和 ggplot2 资源
- [ggplot2 官方文档](https://ggplot2.tidyverse.org/)
- [R for Data Science](https://r4ds.had.co.nz/)
- [WebR 文档](https://docs.r-wasm.org/webr/latest/)
- [OpenCPU 文档](https://www.opencpu.org/)

### 技术文档
- [React Flow 文档](https://reactflow.dev/)
- [React DnD 文档](https://react-dnd.github.io/react-dnd/)
- [Monaco Editor 文档](https://microsoft.github.io/monaco-editor/)

---

## 成功指标

### 产品指标
- 用户能在 5 分钟内创建第一个图表
- 支持 80% 的常用 ggplot2 功能
- 生成的代码可以直接在 R 中运行
- 图表渲染时间 < 3 秒

### 技术指标
- 首屏加载时间 < 5 秒
- 积木拖拽响应时间 < 100ms
- 代码生成实时（< 500ms）
- 单元测试覆盖率 > 70%

---

## 下一步行动

### 立即开始
1. ✅ 创建项目基础架构（已完成）
2. 📝 详细设计积木数据结构
3. 🔬 进行 WebR 技术验证
4. 🎨 设计 UI 原型（Figma）
5. 📋 创建详细的任务列表（GitHub Issues）

### 第一周任务清单
- [ ] 配置 TypeScript
- [ ] 集成 React Flow
- [ ] 创建基础布局组件
- [ ] 设计积木数据结构
- [ ] WebR POC 验证

---

## 总结

GGplotChim 是一个极具创新性的项目，结合了可视化编程和数据科学的优势。通过将 ggplot2 的强大功能封装成直观的积木块，可以大大降低数据可视化的学习门槛，让更多人享受到 R 语言生态的优势。

关键成功因素：
1. 直观的用户界面
2. 准确的代码生成
3. 流畅的性能体验
4. 丰富的图表类型支持

**建议采用敏捷开发方式，快速迭代，先做出 MVP 版本验证核心概念，再逐步完善功能。**

祝项目成功！🚀

