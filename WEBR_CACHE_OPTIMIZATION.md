# WebR ç¼“å­˜ä¼˜åŒ–è¯´æ˜

## é—®é¢˜èƒŒæ™¯

ä¹‹å‰æ¯æ¬¡é‡å¯åº”ç”¨éƒ½éœ€è¦ï¼š
1. ä¸‹è½½ WebR è¿è¡Œæ—¶ï¼ˆçº¦ 10MBï¼‰
2. åˆå§‹åŒ– WebR ç¯å¢ƒ
3. é‡æ–°å®‰è£…æ‰€æœ‰ R åŒ…

è¿™ä¸ªè¿‡ç¨‹éå¸¸è€—æ—¶ï¼Œç‰¹åˆ«æ˜¯ç½‘ç»œè¾ƒæ…¢æ—¶å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼Œç”¨æˆ·ä½“éªŒå¾ˆå·®ã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. æµè§ˆå™¨ç¼“å­˜ WebR è¿è¡Œæ—¶

WebR é€šè¿‡ CDN (https://webr.r-wasm.org/latest/) æä¾›ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨ç¼“å­˜è¿™äº›æ–‡ä»¶ã€‚ç¬¬äºŒæ¬¡å¯åŠ¨æ—¶ï¼ŒWebR æ ¸å¿ƒæ–‡ä»¶ä¼šä»æµè§ˆå™¨ç¼“å­˜åŠ è½½ï¼Œé€Ÿåº¦å¤§å¹…æå‡ã€‚

### 2. localStorage è®°å½•åŒ…å®‰è£…å†å²

ä½¿ç”¨ `localStorage` ä¿å­˜å·²å®‰è£…çš„ R åŒ…åˆ—è¡¨ï¼Œé‡å¯åå¯ä»¥ï¼š
- æ£€æµ‹å“ªäº›åŒ…ä¹‹å‰å®‰è£…è¿‡ï¼ˆæµè§ˆå™¨å¯èƒ½å·²ç¼“å­˜å…¶ WASM æ–‡ä»¶ï¼‰
- æ˜¾ç¤ºç¼“å­˜æç¤ºï¼Œå‘ŠçŸ¥ç”¨æˆ·å“ªäº›åŒ…å¯èƒ½å¿«é€Ÿå®‰è£…
- ä»æµè§ˆå™¨ HTTP ç¼“å­˜å¿«é€ŸåŠ è½½ä¹‹å‰ä¸‹è½½çš„åŒ…æ–‡ä»¶

### 3. æ™ºèƒ½åŒ…ç®¡ç†

æ–°çš„åŒ…å®‰è£…é€»è¾‘ï¼š
```typescript
// æ£€æŸ¥å®‰è£…å†å²
const cachedPackages = this.getCachedPackages();
const previouslyInstalled = selectedPackages.filter(pkg => cachedPackages.includes(pkg));
const newPackages = selectedPackages.filter(pkg => !cachedPackages.includes(pkg));

// é‡è¦ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿæ¯æ¬¡åˆ·æ–°ä¼šé‡ç½®ï¼Œæ‰€ä»¥ä»éœ€è¦"å®‰è£…"æ‰€æœ‰åŒ…
// ä½†ä¹‹å‰å®‰è£…è¿‡çš„åŒ…ï¼Œå…¶ WASM æ–‡ä»¶å·²è¢«æµè§ˆå™¨ç¼“å­˜ï¼Œå®‰è£…ä¼šå¾ˆå¿«
for (const pkg of selectedPackages) {
  const isCached = previouslyInstalled.includes(pkg);
  console.log(`ğŸ“¦ å®‰è£… ${pkg}${isCached ? ' (ä»ç¼“å­˜âš¡)' : ' (éœ€ä¸‹è½½)'}`);
  await this.webR.installPackages([pkg]); // å¦‚æœç¼“å­˜å‘½ä¸­ï¼Œå‡ ä¹ç¬é—´å®Œæˆ
}
```

## åŠŸèƒ½ç‰¹æ€§

### 1. è‡ªåŠ¨ç¼“å­˜

- âœ… WebR è¿è¡Œæ—¶æ–‡ä»¶è‡ªåŠ¨ç¼“å­˜ï¼ˆæµè§ˆå™¨ HTTP ç¼“å­˜ï¼‰
- âœ… R åŒ…çš„ WASM æ–‡ä»¶è‡ªåŠ¨ç¼“å­˜ï¼ˆæµè§ˆå™¨ HTTP ç¼“å­˜ï¼‰
- âœ… å·²å®‰è£…çš„åŒ…åˆ—è¡¨è®°å½•åœ¨ localStorage
- âœ… é‡å¯åè‡ªåŠ¨æ£€æµ‹å®‰è£…å†å²
- âš¡ é‡æ–°å®‰è£…æ—¶ä»æµè§ˆå™¨ç¼“å­˜å¿«é€Ÿè¯»å–ï¼ˆä¸é‡æ–°ä¸‹è½½ï¼‰

### 2. ç¼“å­˜ç®¡ç†ç•Œé¢

åœ¨åŒ…é€‰æ‹©å™¨ä¸­æ˜¾ç¤ºï¼š
- ğŸ’¾ å·²ç¼“å­˜åŒ…çš„æ•°é‡å’Œåˆ—è¡¨
- âš¡ ç¼“å­˜åŒ…çš„å¿«é€ŸåŠ è½½æç¤º
- ğŸ—‘ï¸ ä¸€é”®æ¸…é™¤ç¼“å­˜æŒ‰é’®

### 3. æ™ºèƒ½æç¤º

- é¦–æ¬¡å¯åŠ¨ï¼šæç¤ºéœ€è¦ä¸‹è½½å’Œå®‰è£…
- äºŒæ¬¡å¯åŠ¨ï¼šæ˜¾ç¤º"å·²ç¼“å­˜ï¼Œå¿«é€ŸåŠ è½½"
- éƒ¨åˆ†ç¼“å­˜ï¼šæ˜¾ç¤ºè·³è¿‡çš„åŒ…æ•°é‡

## ç”¨æˆ·ä½“éªŒæå‡

### é¦–æ¬¡å¯åŠ¨ï¼ˆæ— ç¼“å­˜ï¼‰
```
[1/5] å‡†å¤‡åˆå§‹åŒ– WebR...
[2/5] æ­£åœ¨ä¸‹è½½ WebR è¿è¡Œæ—¶ï¼ˆçº¦ 10MBï¼Œé¦–æ¬¡è¾ƒæ…¢ï¼‰...
[4/5] æ­£åœ¨å®‰è£…åŒ… 1/10: ggplot2...
[4/5] æ­£åœ¨å®‰è£…åŒ… 2/10: dplyr...
...
```
**è€—æ—¶ï¼š** 2-5 åˆ†é’Ÿï¼ˆå–å†³äºç½‘ç»œé€Ÿåº¦ï¼‰

### äºŒæ¬¡å¯åŠ¨ï¼ˆæœ‰ç¼“å­˜ï¼Œç›¸åŒåŒ…ï¼‰
```
[1/5] æ£€æµ‹åˆ°ç¼“å­˜ï¼Œå°†å¿«é€Ÿå¯åŠ¨...
[2/5] æ­£åœ¨åŠ è½½ WebRï¼ˆæµè§ˆå™¨å·²ç¼“å­˜ï¼Œé€Ÿåº¦æ›´å¿«ï¼‰...
[4/5] æ­£åœ¨å®‰è£…åŒ… 1/10: ggplot2 (å¯èƒ½ä»ç¼“å­˜è¯»å–âš¡)
[4/5] æ­£åœ¨å®‰è£…åŒ… 2/10: dplyr (å¯èƒ½ä»ç¼“å­˜è¯»å–âš¡)
...
å·²å®‰è£… 10 ä¸ªåŒ…ï¼ˆ0 æ–°ï¼Œ10 é‡è£…ï¼‰
âœ… åˆå§‹åŒ–å®Œæˆï¼
```
**è€—æ—¶ï¼š** 15-30 ç§’ âš¡ï¼ˆé‡è£…ä½†ä»ç¼“å­˜è¯»å–ï¼Œè¿œå¿«äºé¦–æ¬¡ï¼‰

### äºŒæ¬¡å¯åŠ¨ï¼ˆæœ‰ç¼“å­˜ï¼Œæ–°å¢åŒ…ï¼‰
```
[1/5] æ£€æµ‹åˆ°ç¼“å­˜ï¼Œå°†å¿«é€Ÿå¯åŠ¨...
[2/5] æ­£åœ¨åŠ è½½ WebRï¼ˆæµè§ˆå™¨å·²ç¼“å­˜ï¼Œé€Ÿåº¦æ›´å¿«ï¼‰...
[4/5] æ­£åœ¨å®‰è£…åŒ… 1/10: ggplot2 (å¯èƒ½ä»ç¼“å­˜è¯»å–âš¡)
...
[4/5] æ­£åœ¨å®‰è£…åŒ… 9/10: ggstream (éœ€ä¸‹è½½)
[4/5] æ­£åœ¨å®‰è£…åŒ… 10/10: networkD3 (éœ€ä¸‹è½½)
å·²å®‰è£… 10 ä¸ªåŒ…ï¼ˆ2 æ–°ï¼Œ8 é‡è£…ï¼‰
```
**è€—æ—¶ï¼š** 30-60 ç§’ï¼ˆ8 ä¸ªä»ç¼“å­˜å¿«é€ŸåŠ è½½ï¼Œ2 ä¸ªéœ€ä¸‹è½½ï¼‰

## æŠ€æœ¯å®ç°

### æ ¸å¿ƒä»£ç ä¿®æ”¹

#### 1. webRRunner.ts - æ·»åŠ ç¼“å­˜ç®¡ç†

```typescript
// ç¼“å­˜é”®å
const PACKAGE_CACHE_KEY = 'webr-installed-packages';

// è·å–ç¼“å­˜
private getCachedPackages(): string[] {
  const cached = localStorage.getItem(PACKAGE_CACHE_KEY);
  return cached ? JSON.parse(cached) : [];
}

// ä¿å­˜ç¼“å­˜
private saveCachedPackages(packages: string[]): void {
  localStorage.setItem(PACKAGE_CACHE_KEY, JSON.stringify(packages));
}

// æ¸…é™¤ç¼“å­˜
clearCache(): void {
  localStorage.removeItem(PACKAGE_CACHE_KEY);
}
```

#### 2. æ™ºèƒ½åŒ…å®‰è£…é€»è¾‘

```typescript
// æ£€æŸ¥å®‰è£…å†å²
const cachedPackages = this.getCachedPackages();
const previouslyInstalled = selectedPackages.filter(pkg => cachedPackages.includes(pkg));
const newPackages = selectedPackages.filter(pkg => !cachedPackages.includes(pkg));

console.log(`ğŸ’¾ ${previouslyInstalled.length} ä¸ªåŒ…ä¹‹å‰è£…è¿‡ï¼Œæµè§ˆå™¨å¯èƒ½å·²ç¼“å­˜`);
console.log(`ğŸ“¥ ${newPackages.length} ä¸ªæ–°åŒ…éœ€è¦ä¸‹è½½`);

// å®‰è£…æ‰€æœ‰åŒ…ï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå·²é‡ç½®ï¼Œå¿…é¡»é‡æ–°å®‰è£…ï¼‰
// ä½†ä¹‹å‰è£…è¿‡çš„åŒ…ä¼šä»æµè§ˆå™¨ç¼“å­˜å¿«é€Ÿè¯»å–
for (const pkg of selectedPackages) {
  const isCached = previouslyInstalled.includes(pkg);
  console.log(`ğŸ“¦ å®‰è£… ${pkg}${isCached ? ' (ä»ç¼“å­˜âš¡)' : ' (éœ€ä¸‹è½½)'}`);
  await this.webR.installPackages([pkg]); // ç¼“å­˜å‘½ä¸­æ—¶å‡ ä¹ç¬é—´å®Œæˆ
  installedPackages.push(pkg);
}

// ä¿å­˜å®‰è£…å†å²
this.saveCachedPackages(installedPackages);
```

#### 3. UI æ˜¾ç¤ºç¼“å­˜çŠ¶æ€

```typescript
// åŠ è½½ç¼“å­˜ä¿¡æ¯
useEffect(() => {
  const info = webRRunner.getCacheInfo();
  setCacheInfo(info);
}, []);

// æ˜¾ç¤ºç¼“å­˜æ¨ªå¹…
{cacheInfo.hasCachedData && (
  <div className="cache-info-banner">
    <strong>ğŸ’¾ ç¼“å­˜çŠ¶æ€ï¼š</strong> å·²ç¼“å­˜ {cacheInfo.cachedPackages.length} ä¸ªåŒ…
    <button onClick={handleClearCache}>ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</button>
  </div>
)}
```

## ç¼“å­˜å­˜å‚¨è¯´æ˜

### localStorage å­˜å‚¨
- **é”®åï¼š** `webr-installed-packages`
- **æ ¼å¼ï¼š** JSON æ•°ç»„ï¼Œå¦‚ `["ggplot2", "dplyr", "tidyr"]`
- **å¤§å°ï¼š** æå°ï¼ˆé€šå¸¸ < 1KBï¼‰
- **æŒä¹…æ€§ï¼š** é™¤éæ‰‹åŠ¨æ¸…é™¤æˆ–æ¸…ç©ºæµè§ˆå™¨æ•°æ®ï¼Œå¦åˆ™æ°¸ä¹…ä¿ç•™

### æµè§ˆå™¨ç¼“å­˜ï¼ˆè‡ªåŠ¨ï¼‰
- WebR è¿è¡Œæ—¶æ–‡ä»¶ï¼ˆçº¦ 10MBï¼‰
- R åŒ…çš„ WASM æ–‡ä»¶
- ç”±æµè§ˆå™¨è‡ªåŠ¨ç®¡ç†

## æ³¨æ„äº‹é¡¹

### ä½•æ—¶éœ€è¦æ¸…é™¤ç¼“å­˜ï¼Ÿ

1. **æ›´æ–°åŒ…ç‰ˆæœ¬** - å¦‚æœæƒ³ä½¿ç”¨æ–°ç‰ˆæœ¬çš„ R åŒ…
2. **åˆ‡æ¢é¡¹ç›®** - å¦‚æœä¸åŒé¡¹ç›®éœ€è¦ä¸åŒçš„åŒ…
3. **è§£å†³é—®é¢˜** - å¦‚æœé‡åˆ°åŒ…ç›¸å…³çš„é”™è¯¯
4. **èŠ‚çœç©ºé—´** - å¦‚æœæµè§ˆå™¨å­˜å‚¨ç©ºé—´ä¸è¶³

### æ¸…é™¤ç¼“å­˜çš„æ–¹æ³•

1. **ç•Œé¢æ¸…é™¤ï¼š** åŒ…ç®¡ç†å™¨ä¸­ç‚¹å‡»"æ¸…é™¤ç¼“å­˜"æŒ‰é’®
2. **æµè§ˆå™¨æ¸…é™¤ï¼š** æ¸…ç©ºæµè§ˆå™¨çš„ localStorage å’Œç¼“å­˜
3. **å¼€å‘è€…å·¥å…·ï¼š** åœ¨æ§åˆ¶å°æ‰§è¡Œ `localStorage.clear()`

### å±€é™æ€§

- **è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¼šé‡ç½®**ï¼šæ¯æ¬¡åˆ·æ–°é¡µé¢ï¼ŒWebR çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿéƒ½ä¼šé‡ç½®ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°"å®‰è£…"æ‰€æœ‰åŒ…
- **æµè§ˆå™¨ç¼“å­˜æ˜¯å…³é”®**ï¼šé‡æ–°å®‰è£…æ—¶ä¼šä»æµè§ˆå™¨çš„ HTTP ç¼“å­˜è¯»å–åŒ…æ–‡ä»¶ï¼ˆä¸é‡æ–°ä¸‹è½½ï¼‰ï¼Œè¿™æ˜¯é€Ÿåº¦æå‡çš„å…³é”®
- **localStorage åªè®°å½•å†å²**ï¼šå®ƒä¸å­˜å‚¨åŒ…æ–‡ä»¶ï¼Œåªè®°å½•å“ªäº›åŒ…ä¹‹å‰å®‰è£…è¿‡ï¼Œç”¨äºæ˜¾ç¤ºæç¤º
- **ç¼“å­˜åŸºäºåŒä¸€æµè§ˆå™¨**ï¼šåˆ‡æ¢æµè§ˆå™¨éœ€è¦é‡æ–°ä¸‹è½½
- **éšç§æ¨¡å¼ä¸ä¿ç•™**ï¼šæ— ç—•æ¨¡å¼ä¸‹çš„ç¼“å­˜ä¸ä¼šæŒä¹…åŒ–

## æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | é¦–æ¬¡å¯åŠ¨ | äºŒæ¬¡å¯åŠ¨ï¼ˆç›¸åŒåŒ…ï¼‰ | äºŒæ¬¡å¯åŠ¨ï¼ˆæ–°å¢åŒ…ï¼‰ |
|------|----------|-------------------|---------------------|
| WebR åˆå§‹åŒ– | 30-60s | 3-5s âš¡ | 3-5s âš¡ |
| åŒ…å®‰è£…ï¼ˆ10ä¸ªï¼‰ | 60-180s | 10-25s âš¡ | 20-120s âš¡ |
| **æ€»è€—æ—¶** | **2-5åˆ†é’Ÿ** | **15-30ç§’** âš¡ | **30-90ç§’** âš¡ |
| **æå‡** | - | **85-90% å‡å°‘** ğŸš€ | **40-70% å‡å°‘** ğŸš€ |

**è¯´æ˜ï¼š** äºŒæ¬¡å¯åŠ¨æ—¶è™½ç„¶éœ€è¦"é‡æ–°å®‰è£…"æ‰€æœ‰åŒ…ï¼ˆå› ä¸ºè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿé‡ç½®ï¼‰ï¼Œä½†åŒ…çš„ WASM æ–‡ä»¶å·²è¢«æµè§ˆå™¨ç¼“å­˜ï¼Œå®‰è£…è¿‡ç¨‹ä¸»è¦æ˜¯è§£å‹å’Œæ³¨å†Œåˆ°è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œè¿œå¿«äºé¦–æ¬¡ä¸‹è½½å®‰è£…ã€‚

## åç»­ä¼˜åŒ–å»ºè®®

1. **IndexedDB æ·±åº¦é›†æˆ** - å­˜å‚¨åŒ…çš„å®Œæ•´æ–‡ä»¶ç³»ç»ŸçŠ¶æ€
2. **Service Worker** - æ›´ç²¾ç»†çš„ç¼“å­˜æ§åˆ¶
3. **åŒ…ç‰ˆæœ¬ç®¡ç†** - æ£€æµ‹åŒ…ç‰ˆæœ¬æ›´æ–°
4. **é¢„åŠ è½½æ¨èåŒ…** - åœ¨ç”¨æˆ·é€‰æ‹©å‰é¢„å…ˆä¸‹è½½å¸¸ç”¨åŒ…
5. **ç¼“å­˜å¤§å°ç›‘æ§** - æ˜¾ç¤ºç¼“å­˜å ç”¨ç©ºé—´
6. **ç¦»çº¿æ¨¡å¼** - å®Œå…¨ç¦»çº¿è¿è¡Œï¼ˆéœ€è¦ Service Workerï¼‰

## æ€»ç»“

è¿™æ¬¡ä¼˜åŒ–åˆ©ç”¨æµè§ˆå™¨çš„ HTTP ç¼“å­˜æœºåˆ¶ï¼Œå°†äºŒæ¬¡å¯åŠ¨æ—¶é—´ä» **2-5åˆ†é’Ÿ** é™ä½åˆ° **15-30ç§’**ï¼Œå¤§å¹…æå‡äº†ç”¨æˆ·ä½“éªŒã€‚

### å·¥ä½œåŸç†

1. **é¦–æ¬¡å¯åŠ¨**ï¼šä¸‹è½½æ‰€æœ‰åŒ…çš„ WASM æ–‡ä»¶ï¼ˆ2-5åˆ†é’Ÿï¼‰
2. **æµè§ˆå™¨è‡ªåŠ¨ç¼“å­˜**ï¼šåŒ…æ–‡ä»¶è¢«æµè§ˆå™¨çš„ HTTP ç¼“å­˜ä¿å­˜
3. **äºŒæ¬¡å¯åŠ¨**ï¼šè™½ç„¶è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿé‡ç½®äº†ï¼Œä½†é‡æ–°å®‰è£…æ—¶ä»ç¼“å­˜è¯»å–ï¼ˆ15-30ç§’ï¼‰

### ç”¨æˆ·ä½“éªŒæå‡

âœ… äºŒæ¬¡å¯åŠ¨å¿« 85-90%ï¼Œæ— éœ€ç­‰å¾…æ¼«é•¿çš„ä¸‹è½½
âœ… æ¸…æ™°çš„ç¼“å­˜æç¤ºï¼ˆæ˜¾ç¤ºå“ªäº›åŒ…ä»ç¼“å­˜è¯»å–ï¼‰
âœ… localStorage è®°å½•å®‰è£…å†å²ï¼Œæ™ºèƒ½æç¤ºç”¨æˆ·
âœ… äº«å—æ¥è¿‘åŸç”Ÿåº”ç”¨çš„å¯åŠ¨é€Ÿåº¦

âš ï¸ **é‡è¦**ï¼šè™½ç„¶ä¸æ˜¯å®Œå…¨"è·³è¿‡å®‰è£…"ï¼Œä½†ä»ç¼“å­˜é‡è£…æ¯”é¦–æ¬¡ä¸‹è½½å¿«å¾—å¤šï¼

ğŸ‰ å†ä¹Ÿä¸ç”¨æ¯æ¬¡é‡å¯éƒ½ç­‰å¥½å‡ åˆ†é’Ÿäº†ï¼

